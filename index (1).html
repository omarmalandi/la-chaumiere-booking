<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Simple Booking Form</title>
  <style>
    body { font-family: system-ui, Arial; padding:16px; }
    .card { max-width: 520px; margin: 0 auto; padding:16px; border:1px solid #ddd; border-radius:12px; }
    label { display:block; margin:8px 0 4px; font-weight:600; }
    input, select, textarea { width:100%; padding:10px; border:1px solid #ccc; border-radius:10px; }
    button { margin-top:12px; padding:12px 16px; border:0; border-radius:10px; background:#0a7; color:#fff; font-weight:700; }
    .ok { color:#0a7; font-weight:600; }
    .err { color:#c22; font-weight:600; }
  </style>
</head>
<body>
  <div class="card">
    <h2>New Booking</h2>
    <p><a href="bookings.html">View bookings</a></p>
    <form id="f">
      <label>Branch</label>
      <select name="branch" required>
        <option value="La Chaumiere">La Chaumiere</option>
        <option value="Yasmin Al Sham">Yasmin Al Sham</option>
        <option value="Bon Appétit">Bon Appétit</option>
      </select>

      <label>Name</label>
      <input name="name" required placeholder="Full name" />

      <label>Phone</label>
      <input name="phone" required placeholder="Phone number" />

      <label>Date</label>
      <input type="date" name="booking_date" required />

      <label>Time</label>
      <input type="time" name="booking_time" required />

      <label>Party size</label>
      <input type="number" name="party_size" min="1" step="1" required />

      <label>Deposit (optional)</label>
      <input type="number" name="deposit" min="0" step="0.01" />
     
      <label>Receipt (image or PDF)</label>
      <input type="file" name="receipt" accept="image/*,application/pdf" />

      <label>Notes</label>
      <textarea name="notes" placeholder="Any notes..."></textarea>

      <button type="submit">Save booking</button>
      <p id="status"></p>
    </form>
  </div>

  <script type="module">
    import { supabase } from './supabase.js';

    const form = document.getElementById('f');
    const statusEl = document.getElementById('status');

    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      statusEl.textContent = 'Saving...';
      statusEl.className = '';

      const fd = new FormData(form);

      // 1) ارفع الإيصال (اختياري)
      let receipt_path = null;
      const file = fd.get('receipt');
      if (file && file.size > 0) {
        const ext = (file.name.split('.').pop() || 'bin').toLowerCase();
        const filename = `${crypto.randomUUID()}.${ext}`;
        const { error: uploadErr } = await supabase
          .storage
          .from('receipts')           // تأكدنا سابقًا أن البكت اسمه receipts
          .upload(filename, file, { cacheControl: '3600', upsert: false });

        if (uploadErr) {
          statusEl.textContent = 'Error uploading receipt: ' + uploadErr.message;
          statusEl.className = 'err';
          return;
        }
        receipt_path = filename; // نخزن المسار فقط
      }

      // 2) أدخل الحجز في الجدول
      const row = {
        branch:       fd.get('branch'),
        name:         fd.get('name'),
        phone:        fd.get('phone'),
        booking_date: fd.get('booking_date'),
        booking_time: fd.get('booking_time'),
        party_size:   Number(fd.get('party_size')),
        deposit:      fd.get('deposit') ? Number(fd.get('deposit')) : null,
        notes:        fd.get('notes') || null,
        receipt_path  // قد يكون null لو ما رفع ملف
      };

      const { error } = await supabase.from('bookings').insert(row);

      if (error) {
        statusEl.textContent = 'Error: ' + error.message;
        statusEl.className = 'err';
      } else {
        statusEl.textContent = 'Saved ✔';
        statusEl.className = 'ok';
        form.reset();
      }
    });
  </script>

</body>
</html>
